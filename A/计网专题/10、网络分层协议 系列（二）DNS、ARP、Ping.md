# DNS、ARP、Ping



## 1、DNS



> ### 域名

使用域名的主要原因就是方便用户记忆，不然你每次都输入一串 IP 地址去访问，这样多麻烦

输入 访问 url 后，需要先通过 DNS 域名解析，获取到 目的 IP 地址，才能进行 TCP/UDP 通信

 

**根 DNS 服务器最高级，每台 DNS 服务器中都有记录 根域 DNS 服务器**

**根域 DNS 服务器 记录了所有 的 DNS 服务器，这样其他 DNS 服务器可以通过访问 根域 DNS 服务器 来获取其他 DNS 服务器的位置**



`www.baidu.com.root` 这是一个完整的域名，简写为 `www.baidu.com.` ，注意后面有个 `.`，而由于所有的域名后面都有一个 `.root`，因此平时都省略掉了，这里的 `.root` 就是根域名



`.com` 是顶级域名，同时也是一级域名（com 用于商业机构）

`.baidu` 是注册的

`www` 是我们自己定义的

`baidu.com` 是二级域名，`www.baidu.com`是三级域名，当然也可以使用 `fuck.baidu.com`作为三级域名，但是这样不如 www 来得容易记

 ![img](https://pic4.zhimg.com/80/79b9fd2666e989ab24024966632ae63f_720w.png) 

> ### 1、域名解析的工作流程

当我们输入 url 后，会检查 hosts 文件、本地 DNS 服务器缓存是否存在对应的域名解析，如果存在则直接返回，如果不存在则进行 DNS 解析

- 客户端首先会发送一个 DNS 请求给本地 DNS 服务器（点开网络配置可以看到，一般我们是不会配置的，是默认的 DNS 服务器，具体可以看 IP 地址划分那张图，或者自己点开网络配置看），问 www.server.com  的 IP 地址是什么
- 本地 DNS 服务器获取到请求后，如果自己有记录，那么将 IP 地址返回，如果没有，那么找到自己记录的     根 DNS 服务器，询问对应的 IP 地址，“老大， 能告诉我 www.server.com 的 IP 地址吗？”  
- 需要注意的是，根DNS 服务器 并不参与域名解析，但是我们上面说了，根DNS 服务器 存储了所有 DNS 服务器，因此它可以查询出管理 com 的 DNS 服务器，将地址发给 本地 DNS 服务器，（不参与解析，但会指明一条道路）
- 本地 DNS 服务器获取到管理 com 的顶级域名服务器的地址后，发起请问问它：“老二， 你能告诉我 www.server.com  的 IP 地址吗？”
- 顶级域名服务器会告诉 本地 DNS 服务器 管理 server.com 的权威域名服务器地址
- 本地 DNS 获取 权威域名服务器地址，发起请求问：“老三，www.server.com对应的IP是啥呀？”
- 权威 DNS 服务器查询后将对应的 IP 地址 X.X.X.X 告诉本地 DNS。
- 本地 DNS 再将 IP 地址返回客户端，**客户端将 IP 地址进行缓存**，然后和目标建立连接。



**客户端和本地 DNS 之间是递归，本地 DNS 和 各个 DNS 服务器之间是迭代**



> ### 2、DNS 使用的协议



DNS 同时使用了 UDP 和 TCP 协议，占用了 UDP 和 TCP 的 端口53

UDP 简单高效，TCP 加了太多的安全措施，效率低



**DNS 中有两种行为：一种是域名解析，一种是区域传送**

**域名解析：**将 www.baidu.com 解析为 ip 地址

域名解析使用 UDP，如果使用 TCP 的话就需要进行 三次握手四次挥手，其中 TIME_WAIT 默认 2min，而一次 DNS 查询需要连续访问多个服务器，这效率太低了



**区域传送：**

DNS 规定了两种 DNS 服务器，一种叫主 DNS 服务器，一种叫辅助 DNS 服务器，类似 redis 的集群，一个 master 和 多台 slave，在 master 崩了后 slave 可以进行顶替，以及平时帮忙分摊 DNS 查询请求；DNS 服务器一般是一台 master 和 一台 slave

区域传送就是 master 和 slave 需要进行数据同步，master 的数据要传送给 slave，需要保证可靠性，所以使用 TCP



同时 DNS 如果基于 UDP 协议，那么最多只能传输 512 字节的数据，如果超过 512 字节，那么必须进行分片，但是 UDP 又不能进行分片，因此只能使用 TCP 来传输



**即 DNS 使用 TCP 的情况有两种：**

- DNS 报文数据超过 512 字节
- 进行区域传送



> ### 3、根服务器的数量

有流言说全球的 "根服务器 数据量为 13 台，一旦 DDos 攻击了根服务器，那么全球的网络就瘫痪了"

其实不然，在 2014 年，全球有 504 台根服务器，被编号为了 A - M 13 组

所以是 13 组，而不是 13 台



> ### 4、DNS 劫持

 http://www.hackdig.com/?01/hack-1196.htm 



**什么是 DNS 劫持：**

输入 google.com，弹出来的是百度的页面，即 DNS 域名解析获取到的是 假的 ip 地址

HTTP 劫持的现象：打开的知乎页面，结果右下角弹出了 贪玩蓝月 的广告

即 **DNS 劫持导致访问的 ip 不是原来的 ip，HTTP 劫持访问的是原来的 ip，但是却被中间人添加了广告之类的**



**DNS 劫持的类型：**

- **本地 DNS 劫持：**通过植入恶意软件 修改本地 DNS 服务器地址 为攻击者控制的 DNS 服务器，用户请求进行 DNS 解析时 攻击者的 DNS 服务器都会 返回 到恶意站点的 ip 地址
- **中间人 DNS 劫持**：攻击者 通过中间人攻击，拦截 用户 和 DNS 服务器之间的通信，给用户提供 虚假的 ip 地址，从而使用户访问 恶意站点
- **路由器 DNS 劫持：**攻击者利用路由器的漏洞接管路由器，从而设置虚假的 DNS 服务器



**如何防止DNS劫持攻击？**

● 为防止DNS劫持，始终建议使用良好的安全软件和防病毒程序，并确保定期更新软件。

● 安全专家建议使用公共DNS服务器。

● 最好定期检查您的DNS设置是否已修改，并确保您的DNS服务器是安全的。

● 建议使用复杂的密码重置路由器的默认密码。

● 最好远离不受信任的网站，避免下载任何免费的东西。

● 如果您已被感染，建议删除HOSTS文件的内容并重置Hosts File。



## 2、ARP

ARP：地址解析协议，实现从 IP 地址到 MAC 地址的映射，**它工作在数据链路层，但是是网络层的协议**



**在同个网段中**，主机 A 和 主机 B 要进行通信，那么它们就需要知道彼此的 MAC 地址，这样才能够通过交换机进行定向传输

但是如果不知道的话怎么办呢？ 通过 ARP 广播

主机 A 会封装一个 **ARP 请求报文**，内部是 源 IP、目的 IP、源 MAC 地址，然后将这个 ARP 报文发送给交换机，交换机会将这个 ARP 报文 发送 给 除 接收该报文的端口 外的 所有连接该交换机的 主机以及其他的二层设备交换机

（这时候就体现出了三层设备路由器隔离广播域的作用）

当其他的主机收到这个 ARP 报文后，如果发现内部的 目的 IP 是自己的，那么封装一个 ARP 响应报文，它是一个单播的报文，然后交给交换机传输给 主机 A，这样双方都知道了自己的 MAC 地址，可以借助 交换机直接进行通信了





> ### 跨网段获取 MAC 地址

当 主机 A 和 主机 B 处于不同的网络段时，那么 主机 A 发送的 ARP 广播包在同个网络段内所有主机都是不会响应的

但是交换机广播的时候同时也会将这个 ARP 请求包发送给连接的 网关-路由器，这时候 网关-路由器 发现请求的 IP 地址不是同个网段的，那么就会将自己的 MAC 地址 封装成 ARP 响应包，发送给主机 A 

主机 A 获取到后，数据传输的 目的 MAC 地址都是 路由器的 MAC 地址，这样发送给主机 B 的所有数据包都会发送到 路由器上，路由器获取到 数据包后会通过 IP 进行路由转发到 主机 B 上，完成数据传输，主机 B 也通过同样的方式进行通信





> ### ARP 欺骗

但凡局域网发生 ARP 欺骗，都表示 网络存在 "中间人"。

假设局域网中存在 3 台主机 P1,P2,P3，它们都连接上同一台交换机，对应三个接口 p1,p2,p3

假设 P3 是 ARP 攻击的实行者，那么是如何进行攻击的呢？

先回顾下正常下的 ARP 通信

P1 要跟 P2 进行通信，但是不知道 P2 的 MAC 地址，所以会发起 ARP 广播，此时 P2 接收到后回应一个 ARP 单播包，而 P3 **处于 "监听" 状态**

<img src="https://pic4.zhimg.com/80/v2-6522b0e3e1b7e7058152e70953428c74_720w.jpg" style="zoom:80%;" />

正常情况下，P3 收到 ARP 请求包后是会直接舍弃的

但是这里 P3 在 "监听" 之后，会给 P1 发送 ARP 回应包：我就是 P2（MAC3）

<img src="https://picb.zhimg.com/80/v2-383f86e253b689d40ff20d648ce7afac_720w.jpg" style="zoom:80%;" />



很明显，P3 对应的是 MAC3，这明显就是一个 ARP 欺骗行为。

那么 P2 和 P3 的 ARP 回应包都到达 P1 的手里，P1 会如何处理？

P1 收到两个 ARP 回应包：

- 我是 P2，IP 地址是 IP2，我的 MAC 地址是 MAC2
- 我是 P2，IP 地址是 IP2，我的 MAC 地址是 MAC3

这时候 P1 就会很蒙蔽，但它必须选择一个，而默认的规则就是 "后来优先"，即 P1 会选择后面来的 ARP 包作为 P2 的 MAC 地址。

那么 P3 怎么保证自己的 ARP 包一定会比 P2 的先到呢？

实际上 P3 只要不断发送 ARP 欺骗包，就一定能够覆盖掉 P2 的正常包

最终 P1 在 MAC 缓存表上记录了："IP2 -> MAC3"，ARP 欺骗目的达成

<img src="https://picb.zhimg.com/80/v2-bade17b91e12c9f9ad5536858abf1350_720w.jpg" style="zoom:80%;" />



根据规则，当 P1 要跟 P2 通信时，无论是 ping 还是什么，首先都会去查询 ARP 表，这样查找出来的就是 MAC3 了，这样就导致 P1 发送的数据就是发送到 P3 那里了，数据一览无余，而 P2 如果要跟 P1 进行通信，P3 也可以使用相同的方法进行 ARP 欺骗，这样 后续 P1 和 P2 的通信全部由 P3 掌控

<img src="https://pic1.zhimg.com/80/v2-317858c5badea87786011cb8eda6d3fd_720w.jpg" style="zoom:80%;" />



危害就是 P3 控制了数据流，那么可以轻易做到篡改数据、断开通信（断网攻击）、限速攻击（比如突然网络加载很慢），并且明文传输的数据，都会被 P3 窃取



## 3、ping

ping 使用的就是 ICMP 报文，**ICMP 协议跟 TCP/UDP 协议同个等级，但是却是属于网络层**

ICMP 报文类型有：请求/应答、请求超时 等

其中 请求/应答 属于 查询报文类型，请求超时 属于 差错报文类型

ICMP 报文中主要有三个属性：

- 报文类型：标识是请求报文还是回应报文

- 序列号： 每发送一个请求包，序列号 +1，由于 ping 不是只有一次，会连续发送很多个 ping 包

  ```
  正在 Ping www.a.shifen.com [163.177.151.110] 具有 32 字节的数据:
  来自 163.177.151.110 的回复: 字节=32 时间=5ms TTL=49
  来自 163.177.151.110 的回复: 字节=32 时间=7ms TTL=49
  来自 163.177.151.110 的回复: 字节=32 时间=5ms TTL=49
  来自 163.177.151.110 的回复: 字节=32 时间=5ms TTL=49
  ```

- 发送时间：为了计算 往返时间 RRT，好得出网络延迟情况，所以会插入发送时间



ping 的过程：

- 主机 A 执行 ping www.zhujiB.com 命令
- 由于 pnig 的是域名，所以需要进行域名解析，如果没有存储对应的缓存映射，因此会执行 DNS 解析获取 目的 ip 地址
- 将 ICMP 请求包、目的 IP、源 IP 封装成 IP 报文，这时候如果发现没有 目的 MAC 地址，那么使用 ARP 广播获取 目的 MAC 地址，如果是同个网络段的，那么就是主机 B 的 MAC 地址，如果跨网络段，那么获取到的就是 路由器 的 MAC 地址
- 将 IP 报文 和 目的 MAC 地址、源 MAC 地址 发送到交换机，将 目的 MAC 地址 和 源 MAC 地址封装成 MAC 头部，组装到 IP 报文上，变成数据帧，然后根据 MAC 地址发送到对应的 主机 / 路由器 上
- 如果是发送到路由器上，那么路由器会根据 IP 地址 对照 路由表，查找下一跳的地址：可以是路由器，也可以是交换机，最终到达主机 B
- 主机 B 收到 ICMP 请求包后，会按照相同的路径回应一个 ICMP 响应包

![img](https://pic2.zhimg.com/80/v2-356582a65204ac9801a057f13f964db2_720w.png)





 

