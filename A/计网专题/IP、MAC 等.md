# IP、MAC等

## 1、网络层（IP） 和 数据链路层（MAC） 的关系

> ### IP 地址是什么？ MAC 地址又是什么？

IP 地址是逻辑地址：只要没有发生重复，那么是可以进行更换的，就跟手机号一样，可以作为标识，但是你可以随时更换手机号，前提是更换的手机号跟别人的不能重复

- 对于 公网 ip，全世界都进行连通，因此不能重复
- 对于内网 ip，只在自己的主机上连通，因此可以跟别人主机上的 内网 ip 重复，因为也没有进行连通，所以重复没有什么问题



MAC 地址是物理地址、硬件地址：每一台主机 / 手机 里都有网卡，而网卡 都有自己的 MAC 地址，每个网卡出产的时候就都跟MAC 地址 进行绑定了，除非更换网卡，否则主机/手机 的 MAC 地址是不会发生改变的，即通过 MAC 地址可以唯一确定 一个 主机/手机 的身份和位置



MAC 地址具有全球唯一性，IP 地址在同一个网络（局域网内、广域网内）内具有唯一性



在不同位置使用相同的电脑，他的 IP 地址可能是不同的

在不同位置使用相同的电脑，他的 MAC 地址一定是相同的



IP 地址相当于是一个大概的范围，比如 某省某市，MAC 地址相当于是某区某村

当跨网的时候，使用 IP 地址大概找到对应的范围，再通过 MAC 地址 找到对应的具体位置



> ### 局域网（LAN）、广域网（WAN）、互联网

具体关系看 https://www.zhihu.com/question/51295773 



局域网（Local Area Network）：

- 局部连通的网络，比如 自己家有一个无线路由器，它把电脑、手机等设备都连接到局域网 LAN 上，这时候这个家就可以当作一个局域网
- 局域网内通信使用的是 私网 ip

广域网（WAN）：

- 将多个局域网连接起来进行通信
- 广域网内进行通信使用的是 公网 ip

互联网就是最大的一个广域网，即将全世界的局域网都连接起来



> ### 路由器 和 交换机

具体关系看 

 https://www.zhihu.com/question/22007235/answer/402261894 

 https://www.zhihu.com/question/22007235/answer/402261894 



交换机：

- 由于局域网内的主机设备很近，所以可以直接使用 交换机 进行连接，相当于是拉网线，网线可以不长，所以花费少
- 交换机连接的是各个硬件间的 MAC 地址，具有一张 MAC 表，MAC 表指代的是 某个 MAC 地址上设备用来通信的接口

路由器：

- 如果是 广域网，即多个局域网之间的连通，那么比如 北京的一个局域网到上海的一个局域网，我们不可能直接拉网线进行连接，因此需要使用路由器进行跳转
- 路由器具有 路由表，路由器会找最优的路径，然后跳到最优路径上的下一个路由器



在局域网内进行通信的时候，使用 交换机，使用的是私网 ip

跨网通信的时候，使用路由器，由于局域网 是 私网 ip，所以无法在互联网上进行通信，因此路由器会进行 ip 转换变成 公网 ip



## 2、应用层（HTTP）和 传输层（TCP） 和 网络层（IP） 的关系

具体关系看  https://www.zhihu.com/question/38648948/answer/240006409 



HTTP 负责告知发送哪些数据，以及数据对应的含义

TCP 负责发送 HTTP 的数据

- 发送方的 TCP 保证 HTTP 数据可靠发送，将数据交给 IP 进行传输，如果 IP 数据传输丢失了，那么 TCP 会再打包一份数据交给 IP 继续发送
- 接受方的 TCP 接收 IP 传输过来的数据 并且 按序拼接数据

IP 负责传输 TCP 发送的数据，数据丢失了也不会采取什么措施



## 3、七层网络模型 和 TCP/IP 网络五层模型

> ### OSI 七层模型 和 网络的 五层模型

![img](https://picb.zhimg.com/80/v2-8241be381782789f7fb5735d8541c506_720w.jpg)





| OSI中的层    | 功能                                               | TCP/IP协议族                                  |
| ------------ | -------------------------------------------------- | --------------------------------------------- |
| 7 应用层     | 文件传输，电子邮件，文件服务，虚拟终端             | TFTP，HTTP，SNMP，FTP，SMTP，DNS，Telnet 等等 |
| 6 表示层     | 数据格式化，代码转换，数据加密                     | 没有协议                                      |
| 5 会话层     | 解除或建立与别的接点的联系                         | 没有协议                                      |
| 4 传输层     | 提供端对端的接口                                   | TCP，UDP                                      |
| 3 网络层     | 为数据包选择路由                                   | IP，ICMP，OSPF，EIGRP，IGMP                   |
| 2 数据链路层 | 传输有地址的帧以及错误检测功能                     | SLIP，CSLIP，PPP，MTU                         |
| 1 物理层     | 在物理媒介（电话线、空气（WIFI））上传输二进制数据 | ISO2110，IEEE802，IEEE802.2                   |



> ### TCP/IP 每层使用的协议

物理层：RJ45、CLOCK、IEEE802.3 （中继器，集线器）

数据链路：PPP、 MTU 、VPN、Ethernet（以太网）（网桥，交换机）

网络层：IP、ICMP（ping）、ARP、RARP （路由器）

传输层：TCP、UDP

会话层：

表示层：

应用层：FTP、DNS、HTTP



> ### 为什么分层

分层就跟 java 类一样，各司其职，只需要考虑自己的任务即可

并且如果有地方需要进行修改，那么修改需要变动的层即可

 **每一层独立于其他层完成自己的工作，而不需要相互依赖，上下层之间通过标准接口来互相通信，简单易用又具有扩展性。** 





## 4、数据链路层（MAC）

数据传输的层顺序为：应用层 -> 传输层 -> 网络层 -> 数据链路层 -> 物理层 

在其他的层上都没有数据限制，而在数据链路层上存在 MTU（最大传输单元） 的限制

因此一次发送的数据（数据 + TCP 头部 + IP 头部）最好不要超过 MTU，否则会在 IP 层发生分片，这样如果某一片丢失了，TCP 需要传输未分片前的整个数据包，后续还要分片，而分成多个数据包进行传输，丢失重发的概率更大

比如一个数据包传输，丢失了发送这一个数据包，一个数据包分片，其中一个分片包丢失了，整个数据包重发，显然后者效率低



从网络层传输过来的 IP 报文会在数据链路层封装成数据帧

![img](https://picb.zhimg.com/80/v2-f4b0790fab228137d031b10b9a1979c7_720w.jpg)





## 5、DNS



> ### 域名

使用域名的主要原因就是方便用户记忆，不然你每次都输入一串 IP 地址去访问，这样多麻烦

输入 访问 url 后，需要先通过 DNS 域名解析，获取到 目的 IP 地址，才能进行 TCP/UDP 通信

 

**根 DNS 服务器最高级，每台 DNS 服务器中都有记录 根域 DNS 服务器**

**根域 DNS 服务器 记录了所有 的 DNS 服务器，这样其他 DNS 服务器可以通过访问 根域 DNS 服务器 来获取其他 DNS 服务器的位置**



`www.baidu.com.root` 这是一个完整的域名，简写为 `www.baidu.com.` ，注意后面有个 `.`，而由于所有的域名后面都有一个 `.root`，因此平时都省略掉了，这里的 `.root` 就是根域名



`.com` 是顶级域名，同时也是一级域名（com 用于商业机构）

`.baidu` 是注册的

`www` 是我们自己定义的

`baidu.com` 是二级域名，`www.baidu.com`是三级域名，当然也可以使用 `fuck.baidu.com`作为三级域名，但是这样不如 www 来得容易记



> ### 1、域名解析的工作流程

当我们输入 url 后，浏览器会看自己缓存中是否存在 域名对应的 IP 地址，如果没有，那么找操作系统缓存要，如果没有，那么找本地 host 文件要，如果还没有，那么就会通过 DNS 服务器查询，具体过程如下：

- 客户端首先会发送一个 DNS 请求给本地 DNS 服务器（点开网络配置可以看到，一般我们是不会配置的，是默认的 DNS 服务器，具体可以看 IP 地址划分那张图，或者自己点开网络配置看），问 www.server.com  的 IP 地址是什么
- 本地 DNS 服务器获取到请求后，如果自己有记录，那么将 IP 地址返回，如果没有，那么找到自己记录的     根 DNS 服务器，询问对应的 IP 地址，“老大， 能告诉我 www.server.com 的 IP 地址吗？”  
- 需要注意的是，根DNS 服务器 并不参与域名解析，但是我们上面说了，根DNS 服务器 存储了所有 DNS 服务器，因此它可以查询出管理 com 的 DNS 服务器，将地址发给 本地 DNS 服务器，（不参与解析，但会指明一条道路）
- 本地 DNS 服务器获取到管理 com 的顶级域名服务器的地址后，发起请问问它：“老二， 你能告诉我 www.server.com  的 IP 地址吗？”
- 顶级域名服务器会告诉 本地 DNS 服务器 管理 server.com 的权威域名服务器地址
- 本地 DNS 获取 权威域名服务器地址，发起请求问：“老三，www.server.com对应的IP是啥呀？”
- 权威 DNS 服务器查询后将对应的 IP 地址 X.X.X.X 告诉本地 DNS。
- 本地 DNS 再将 IP 地址返回客户端，**客户端将 IP 地址进行缓存**，然后和目标建立连接。



> ### 2、迭代和递归两种方式

上面的方式就是默认的递归解析的方式，**DNS 解析是递归还是迭代主要看的是 客户端与什么进行**

如果跟上面一样 都是本地 DNS 跟其他的域名服务器进行交流的，那么就是递归，我们分解来看，本地 DNS 和 其他域名服务器之间是迭代的格式，但是对于客户端来说，它是直接最终获取到结果的，并没有参与中间的过程，即 **DNS 递归**



如果客户端请求一个域名，本地DNS 没有找到缓存，给客户端 根域名服务器的地址，让它自己发请求询问，当发起请求后，根域名服务器给它 顶级域名服务器的地址，让它自己去发请求询问，。。。，这样下去，都是客户端自己与各个域名服务器进行交流，这样的方式称作 **DNS 迭代**



> ### 3、DNS 在哪里使用了 UDP 、TCP 协议



人们默认 DNS 使用的是 UDP 协议，其实不然，DNS 同时使用了 UDP 和 TCP 协议，占用了 UDP 和 TCP 的 端口53

TCP 主要就是保证可靠传输 和 数据的有序性，而 UDP 是不可靠传输并且不能保证数据的有序性

既然 UDP 是不可靠的，为什么还要使用 UDP 呢？

因为 UDP 的速度是 TCP 望尘莫及，TCP 加入了各种安全保障功能，使得占用了大量的开销，速度严重下降



**DNS 中有两种行为：一种是域名解析，一种是区域传送**



```java
域名解析使用 TCP 连接：
DNS 域名解析时间 = TCP 连接时间（三次握手、四次挥手） + DNS 交易时间

域名解析使用 UDP 连接：
DNS 域名解析时间 = DNS 交易时间
```

就从上面看，可以发现好像只不过是多了 TCP 连接时间么，但其实，在用户访问冷门网站的时候，由于 本地DNS服务器 没有冷门网站的缓存，需要到根服务器、顶级域名服务器、权威域名服务器迭代查询，知道查询到冷门网站所在的权威服务器，这种间会需要很多次的 TCP 连接，多几次查询，就多几次 TCP 连接时间，时间开销大

**因此，域名解析使用 UDP 协议**



DNS 规定了两种 DNS 服务器，一种叫主 DNS 服务器，一种叫辅助 DNS 服务器，主 DNS 服务器从自己的本地文件中读取 该区的 DNS 数据，辅助 DNS 服务器从 主 DNS 服务器上同步该区的 DNS 服务器；当一个 辅助 DNS 服务器启动时，它会与 主 DNS 服务器进行通信，并且同步数据，**这个叫做区域传送**

这个 主 DNS 服务器 和 辅助 DNS 服务器就类似 redis 的主从复制，辅助 DNS 服务器是为了在 主 DNS 服务器崩溃时顶上去的，以及平时帮主 DNS 服务器减轻读的压力

因为需要同步数据，要保证 主 DNS 服务器和 辅助 DNS 服务器 的数据一样，所以必须使用可靠的 TCP 协议，同时，基于 UDP 协议 的 DNS 报文最大为 512 字节，如果同步的数据超过 512 字节的话就有点问题了，

**因此，区域传送使用 TCP 协议**



> ### 4、根服务器的数量

有流言说全球的 "根服务器 数据量为 13 台，一旦 DDos 攻击了根服务器，那么全球的网络就瘫痪了"

其实不然，在 2014 年，全球有 504 台根服务器，被编号为了 A - M 13 组

所以是 13 组，而不是 13 台





## 6、ARP

ARP：地址解析协议，实现从 IP 地址到 MAC 地址的映射，即询问 目的 IP 对应的 MAC 地址



假设 A ping B，那么会封装成 ICMP 报文，其他包括 A 的 ip、A 的 MAC、B 的 ip、B 的主机

但是如果 A 不知道 B 的 MAC，那么就会封装失败那么就无法进行通信，好比 送快递知道 收件人姓名（IP） 但不知道地址（MAC）,那么这个快递就无法寄出

因此，A 需要获取 B 的 MAC 地址，通过向全网段 广播 【ARP 请求包】，其中包括 A 的 ip、A 的 MAC、B 的 ip

当整个网段中的 主机都收到这个 【ARP 请求包】时，会拆开看，如果发现其中请求的 ip 地址不是自己的 ip，那么直接将包丢弃，如果发现其中的 ip 地址是自己的 ip，那么根据 包中的 A 的 ip 和 A 的 MAC 将自己的 MAC 地址封装到 【ARP 回应包】 中单播 发送给 A ，其他的主机不会受到这个 【ARP 回应包】

当 A 收到这个 【ARP 回应包】 的时候，拆开获取 B 的 MAC 地址，并且添加进行自己的 【ARP 缓存表】中，方便下次直接使用，而这个 缓存表是存储在内存中的，因此关机就会消失，并且里面的数据是具有一定时效性的，到了过期时间就无效了

（可以通过 arp -a 查询已经缓存的 MAC 地址）

*![image.png](https://pic.leetcode-cn.com/1600697523-buYJrB-image.png)*



**一般 ARP 协议是运行在 同个网段下的，因为广播不能跨网段**



> ### 那么如果是跨网段下的 ping 呢？

什么时候是跨网段？

当主机 A 和 主机 B 使用子网掩码 & ip 的时候，得到的网络号不同，那么就是跨网段的



当 A ping B 是跨网段的时候，与 A 同个网段的主机都会收到 ARP 请求，但是由于它们都不是目的主机，所以会舍弃

**网关设备（路由器）**收到后发现 B 不是当前网段的，那么就会返回自己的 MAC 地址给 A

A 拿到后，发送 ping 消息，这时候目的 MAC 地址是网关的了，因此这个消息会发送到网关上，网关通过路由将 消息发送给 B

B 收到后通过相同原理发送给 A



> ### ARP 到达是属于 数据链路层还是网络层？

从功能上看，ARP 为数据链路层服务，寻找 MAC 地址，属于 数据链路层

从分层上看，ARP 属于 网络层

默认情况下还是当作网络层吧



> ### ARP 欺骗

但凡局域网发生 ARP 欺骗，都表示 网络存在 "中间人"。

假设局域网中存在 3 台主机 P1,P2,P3，它们都连接上同一台交换机，对应三个接口 p1,p2,p3

假设 P3 是 ARP 攻击的实行者，那么是如何进行攻击的呢？

先回顾下正常下的 ARP 通信

P1 要跟 P2 进行通信，但是不知道 P2 的 MAC 地址，所以会发起 ARP 广播，此时 P2 接收到后回应一个 ARP 单播包，而 P3 **处于 "监听" 状态**

<img src="https://pic4.zhimg.com/80/v2-6522b0e3e1b7e7058152e70953428c74_720w.jpg" style="zoom:80%;" />

正常情况下，P3 收到 ARP 请求包后是会直接舍弃的

但是这里 P3 在 "监听" 之后，会给 P1 发送 ARP 回应包：我就是 P2（MAC3）

<img src="https://picb.zhimg.com/80/v2-383f86e253b689d40ff20d648ce7afac_720w.jpg" style="zoom:80%;" />



很明显，P3 对应的是 MAC3，这明显就是一个 ARP 欺骗行为。

那么 P2 和 P3 的 ARP 回应包都到达 P1 的手里，P1 会如何处理？

P1 收到两个 ARP 回应包：

- 我是 P2，IP 地址是 IP2，我的 MAC 地址是 MAC2
- 我是 P2，IP 地址是 IP2，我的 MAC 地址是 MAC3

这时候 P1 就会很蒙蔽，但它必须选择一个，而默认的规则就是 "后来优先"，即 P1 会选择后面来的 ARP 包作为 P2 的 MAC 地址。

那么 P3 怎么保证自己的 ARP 包一定会比 P2 的先到呢？

实际上 P3 只要不断发送 ARP 欺骗包，就一定能够覆盖掉 P2 的正常包

最终 P1 在 MAC 缓存表上记录了："IP2 -> MAC3"，ARP 欺骗目的达成

<img src="https://picb.zhimg.com/80/v2-bade17b91e12c9f9ad5536858abf1350_720w.jpg" style="zoom:80%;" />



根据规则，当 P1 要跟 P2 通信时，无论是 ping 还是什么，首先都会去查询 ARP 表，这样查找出来的就是 MAC3 了，这样就导致 P1 发送的数据就是发送到 P3 那里了，数据一览无余，而 P2 如果要跟 P1 进行通信，P3 也可以使用相同的方法进行 ARP 欺骗，这样 后续 P1 和 P2 的通信全部由 P3 掌控

<img src="https://pic1.zhimg.com/80/v2-317858c5badea87786011cb8eda6d3fd_720w.jpg" style="zoom:80%;" />



危害就是 P3 控制了数据流，那么可以轻易做到篡改数据、断开通信（断网攻击）、限速攻击（比如突然网络加载很慢），并且明文传输的数据，都会被 P3 窃取





## 7、ping

ping 使用的是 ICMP 协议，发送的是 ICMP 报文

ping 是网络层的，所以需要经过 IP 协议封装成 IP 报文再传输到数据链路层

ICMP 报文中主要有三个属性：

- 报文类型：标识是请求报文还是回应报文

- 序列号： 每发送一个请求包，序列号 +1，由于 ping 不是只有一次，会连续发送很多个 ping 包

  ```
  正在 Ping www.a.shifen.com [163.177.151.110] 具有 32 字节的数据:
  来自 163.177.151.110 的回复: 字节=32 时间=5ms TTL=49
  来自 163.177.151.110 的回复: 字节=32 时间=7ms TTL=49
  来自 163.177.151.110 的回复: 字节=32 时间=5ms TTL=49
  来自 163.177.151.110 的回复: 字节=32 时间=5ms TTL=49
  ```

- 发送时间：为了计算 往返时间 RRT，好得出网络延迟情况，所以会插入发送时间



ping 的主要过程：

- A ping B，如果使用的是域名，那么使用 DNS 查找对应的 ip 地址
- A 封装一个 类型为 请求 的 ICMP 请求包，然后将 ICMP 请求包 和 ip 地址都交给 IP 层，加入 IP 头封装成一个 IP 报文
- 最后需要 MAC 地址，查找 ARP 表，如果没有目标 ip 地址的 MAC，那么使用 ARP 广播获取对应的 MAC 地址
- 获取到 MAC 地址后，将 IP 报文 和 MAC 地址交给数据链路层，封装成一个数据帧，再发送出去
- B 收到数据帧后，检查 MAC 地址是否是自己的，如果是则封装一个 ICMP 回应包发送出去，如果不是则直接舍弃

在规定时间内，如果 A 收到了 B 的 ICMP 应答包，表示可达，否则不可达



![img](https://pic2.zhimg.com/80/v2-356582a65204ac9801a057f13f964db2_720w.png)









