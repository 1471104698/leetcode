# synchronized 



关于 synchronized  的几个问题

- synchronized 原理
- synchronized 锁升级过程
- synchronized 是重量级锁，那有哪些轻量级锁



## 1、synchronized 原理



**synchronized 最开始保证 线程安全 / 原子性 是因为它是一把重量级锁，会阻塞其他的线程**

**保证可见性就是因为线程在获取锁时会将工作内存清空，然后从内存中读取新的数据，释放锁前会将工作内存中的数据写回主存**



**synchronized 重量级锁的实现实际上是靠 Java 对象头**

Java 对象都是 存储在堆中的，而对象实例不仅仅只有用户写的代码，JVM 会自动添加一些额外的信息，来帮助一些事情，这些信息就构成了对象头

对象头包括：Mark Word、Klass Word、数组长度

- Mark Word 64 位，内部分割为多个部分，用来标记锁的状态、是否可 GC 回收、以及 `hashCode`
- Klass Word 标记了该对象在方法区中的 元数据，通过该指针确定是哪个类的实例
- 数组长度 是只有该对象为数组时才有的

 ![img](https://img-blog.csdnimg.cn/20190115141050902.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NDRE5fQ1A=,size_16,color_FFFFFF,t_70) 

 

而 synchronized 就是用到了 对象头中的 Mark Word  信息

最开始的 synchronized  是重量级锁，在 Mark Word 中只有 无锁 和 有锁（重量级锁） 两种状态

锁 的底层是 JVM 基于 monitor 对象来实现的，当某个代码块添加了 synchronized  关键字，那么在编译的时候，就是在代码块前面添加一条 `monitorenter` 指令表示加锁，在方法结束处 和 异常处 添加一条 `monitorexit` 指令表示释放锁

它内部还有一个计数器，当持有锁的线程再次需要获得锁的时候，可以直接获取，然后计数器 +1，当计数器为 0 的时候，那么释放锁（原理跟上面的 ReentrantLock 的可重入实现差不多）



## 2、锁升级过程

后续版本的 JDK 对 synchronized  进行了优化，使得 synchronized  的性能跟 ReentrantLock 差不多，差别主要是 ReentrantLock 用户能够自行释放锁

原本的 synchronized  只有两个状态：无锁，重量级锁；

后续再添加了两种状态，变成了 四种状态：**无锁、偏向锁、轻量级锁、重量级锁**

**偏向锁、轻量级锁 都是 乐观锁， 重量级锁 是 悲观锁**



偏向锁是 认为大多数的锁都不会存在竞争，一般都是由一个线程持有

轻量级锁是 认为两个线程使用锁的时间是错开的，即基本不会同时使用，最多也就通过 CAS 等待一会而已

重量级锁是 锁竞争激烈的情况下，为了不让 其他线程 CAS 浪费 CPU 空转，直接阻塞线程，同时它重量级的原因就是，阻塞了线程后需要去唤醒线程，然后再去切换线程，线程切换是用户态和内核态的切换，时间花费大



**锁升级过程：**

- 对象初始化的时候，没有被其他线程占有，那么这时**这个对象是 可偏向 状态**，也就是它只认为只有一个线程会来访问它，当**第一个线程来访问它的时候，它会通过 CAS 将自己的线程 ID 设置为该线程**，**该对象 从 可偏向状态 转换为 偏向 状态**，以后，改线程再来访问该对象时，只需要对比 ID 即可，如果一样则可以直接获取，无需 CAS
- 可能过了很久很久，当第二个线程来访问对象时，发现 该对象 是 偏向状态，表示在以前有线程访问这个对象了，导致它变成了 偏向状态，那么检查下该对象的 线程 ID 对应的线程 是否还存活（因为即使线程消亡了，对象的偏向状态也不会主动改变，需要别的线程来这样帮它改变），如果存活，那么检查下该线程是否仍然持有这个偏向锁，如果持有，那么该锁会升级为轻量级锁，此时锁仍由原来的线程持有，而第二个线程会 CAS 自旋，等待获取锁；；； 如果没有存活 或者 不持有，那么不会升级为轻量级锁，表示该对象可以重新偏向，将锁的 线程 ID 设置为 自己
- 当升级为轻量级锁后，如果 CAS 一段时间 第一个线程还没有释放锁，或者 有第三个线程来访问 了，那么就会升级为重量级锁，阻塞线程，避免不持有锁的其他线程 无意义的 CAS 自旋，浪费 CPU

