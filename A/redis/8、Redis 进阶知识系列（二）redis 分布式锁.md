# redis åˆ†å¸ƒå¼é”



[ç»†è¯´Redisåˆ†å¸ƒå¼é”ğŸ”’](https://juejin.cn/post/6844904082860146695 )

## 1ã€setnx + expire

åˆ†å¸ƒå¼é”çš„å®ç° å°±ç›®å‰æœ€å¸¸å¬åˆ°çš„å°±æ˜¯  setnx + expire å‘½ä»¤äº†

ä½†ä¸æ˜¯æŒ‡ setnx key value + expire key seconds ä¸¤æ¡å‘½ä»¤ï¼Œè¿™æ ·çš„è¯æ˜¯æ²¡æœ‰åŸå­æ€§çš„

è€Œæ˜¯ä½¿ç”¨ set å‘½ä»¤ï¼Œè‡³æ­¤ï¼Œset å‘½ä»¤å·²ç»å»¶ä¼¸å‡ºå¾ˆå¤šçš„å‚æ•°äº†

` SET key value [EX seconds|PX milliseconds] [NX|XX] [KEEPTTL] `



set å·²ç»èƒ½å¤Ÿå®Œå…¨æ›¿ä»£ setnx å‘½ä»¤äº†ï¼Œå¹¶ä¸”èƒ½å¤Ÿå°† setnx + expires ä¸¤æ¡æŒ‡ä»¤çš„åŠŸèƒ½ç»„åˆä¸ºä¸€æ¡æŒ‡ä»¤

```java
127.0.0.1:6379> set a 2 EX 30 NX		//setnx + expires
OK
127.0.0.1:6379> ttl a					//æŸ¥çœ‹è¿‡æœŸæ—¶é—´
(integer) 27
127.0.0.1:6379> set a 2 EX 30 NX		//a é”®å·²ç»å­˜åœ¨ï¼Œå› æ­¤æ²¡æœ‰æ“ä½œï¼Œè¿”å› null
(nil)

```

set a 2 EX 30 NX è§£è¯»ï¼š

- set a 2 è¡¨ç¤ºè®¾ç½® key = a çš„å€¼ä¸º value = 2

- EX 30 è¡¨ç¤ºè®¾ç½®è¿‡æœŸæ—¶é—´ä¸º 30s 

- NX è¡¨ç¤ºå¦‚æœä¸å­˜åœ¨å°±è®¾ç½®ï¼Œå­˜åœ¨åˆ™ä¸è®¾ç½®



> #### setnx + expire çš„é—®é¢˜

å¦‚æœä¸è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé‚£ä¹ˆä¸€æ—¦è·å–é”çš„è¿›ç¨‹å´©äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªé”å°†æ— æ³•å¾—åˆ°é‡Šæ”¾

æ‰€ä»¥éœ€è¦è®¾ç½®è¶…æ—¶æ—¶é—´



å¦‚æœè®¾ç½®äº†è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœè¿›ç¨‹ A è·å–äº†é”ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 30sï¼Œé‚£ä¹ˆå¦‚æœè¿›ç¨‹ A è®¾ç½®çš„è¶…æ—¶æ—¶é—´è¿‡äº†ï¼Œè€Œè‡ªå·±çš„æ•°æ®è¿˜æ²¡æœ‰å¤„ç†å®Œï¼Œå› æ­¤é”è‡ªå·±é‡Šæ”¾äº†ï¼Œå°”åè¿›ç¨‹ B è·å–äº†é”ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 30sï¼Œç„¶åè¿›ç¨‹ A å¤„ç†å®Œäº†ï¼Œæ‰§è¡Œé‡Šæ”¾é”çš„é€»è¾‘ï¼Œå¯¼è‡´è¿›ç¨‹ B æ–°è·å–çš„é”è¢«è¿›ç¨‹ A é‡Šæ”¾äº†ï¼Œè¿™æ ·çš„è¯è¿›ç¨‹ C è·å–äº†é”ï¼Œè¿›ç¨‹ B åˆé‡Šæ”¾äº†è¿›ç¨‹ C çš„é”ã€‚ã€‚ã€‚æ— é™å¥—å¨ƒï¼Œè¿™æŠŠé”å°±èµ·ä¸åˆ°ä»»ä½•ä½œç”¨



å› æ­¤ä½¿ç”¨ setnx è·å–é”çš„æ—¶å€™ï¼Œä¸ä»…ä»…éœ€è¦ä½¿ç”¨ keyï¼Œè¿˜éœ€è¦ä½¿ç”¨ valueï¼Œæ¯ä¸ªè¿›ç¨‹è·å–é”å‰éƒ½è®¾ç½®ä¸€ä¸ªå±äºè‡ªå·±çš„å”¯ä¸€ valueï¼Œä¸€èˆ¬ä½¿ç”¨ uuidï¼Œsetnx è·å–é”çš„æ—¶å€™å°† key - value è¿›è¡Œæ˜ å°„ï¼Œè¿™æ ·åœ¨é‡Šæ”¾é”çš„æ—¶å€™ï¼Œå¯ä»¥å…ˆè·å– value åˆ¤æ–­å½“å‰è¿™æŠŠé”æ˜¯ä¸æ˜¯è¿˜æ˜¯è‡ªå·±çš„ï¼Œå¦‚æœæ˜¯åˆ™é‡Šæ”¾ï¼Œå¦‚æœä¸æ˜¯è¡¨ç¤ºå·²ç»è¶…æ—¶è‡ªåŠ¨é‡Šæ”¾äº†ï¼Œé‚£ä¹ˆå°±ä¸ç®¡äº†

å…·ä½“å®ç°å¦‚ä¸‹ï¼š

```java
String uuid = xxxx;
// ä¼ªä»£ç ï¼Œå…·ä½“å®ç°çœ‹é¡¹ç›®ä¸­ç”¨çš„è¿æ¥å·¥å…·
// æœ‰çš„æä¾›çš„æ–¹æ³•åä¸ºset æœ‰çš„å«setIfAbsent
set Test uuid NX PX 3000
try{
// biz handle....
} finally {
    // unlock
    if(uuid.equals(redisTool.get('Test')){
        redisTool.del('Test');
    }
}
```



ä½†æ˜¯ä¸Šé¢çš„å®ç°è¿˜æ˜¯æœ‰é—®é¢˜çš„ï¼Œ**åœ¨ finally ä¸­ get() å’Œ del() ä¸æ˜¯åŸå­æ“ä½œï¼Œå› æ­¤å¯èƒ½å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜**ï¼Œæ¯”å¦‚çº¿ç¨‹ A æ‰§è¡Œå®Œ get() åå‘ç° é”çš„ value æ˜¯è‡ªå·±çš„ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥åˆ° if() ç»“æ„ä½“å†…ï¼Œä½†æ˜¯è¿™æ—¶å€™å‘ç”Ÿ CPU åˆ‡æ¢ï¼ŒåŒæ—¶é”è¶…æ—¶é‡Šæ”¾äº†ï¼Œçº¿ç¨‹ B è·å–é”ï¼Œç„¶åå†æ¬¡å‘ç”Ÿçº¿ç¨‹åˆ‡æ¢ï¼Œè¿›ç¨‹ A æ‰§è¡Œ del() å‘½ä»¤ï¼ˆdel() åªæ˜¯æ“ä½œ keyï¼Œå®ƒä¸ä¼šå»çœ‹ valueï¼‰ï¼Œå°†çº¿ç¨‹ B è®¾ç½®çš„ key ç»™åˆ é™¤äº†ï¼Œå¯¼è‡´å°† çº¿ç¨‹ B æ–°è·å–çš„é”ç»™é‡Šæ”¾äº†ï¼Œè¿™æ ·çš„è¯çº¿ç¨‹ B å°±ç›¸å½“äºæ²¡æœ‰é”äº†ï¼Œè¿™æŠŠé”åˆæ²¡ç”¨äº†



å› æ­¤ï¼ŒçœŸæ­£ä¿è¯çº¿ç¨‹å®‰å…¨çš„åˆ†å¸ƒå¼é”çš„ï¼Œéœ€è¦ä½¿ç”¨ lua è„šæœ¬



## 2ã€lua è„šæœ¬ï¼ˆRedissionï¼‰

lua è„šæœ¬æ˜¯ä½¿ç”¨ redis çš„ eval å‘½ä»¤æ¥æ‰§è¡Œ

æ— è®º lua è„šæœ¬å†…éƒ¨å¤šå°‘æŒ‡ä»¤ï¼Œå®ƒéƒ½æ˜¯é€šè¿‡ä¸€æ¡ eval å‘½ä»¤å»æ‰§è¡Œçš„ï¼Œå†…éƒ¨è‡ªåŠ¨ä¿è¯åŸå­æ€§

```lua
    -- lua è„šæœ¬åˆ é™¤é”ï¼š
    -- KEYS å’Œ ARGV åˆ†åˆ«æ˜¯ä»¥é›†åˆæ–¹å¼ä¼ å…¥çš„å‚æ•°ã€‚
	-- è¿™ä¸ªé›†åˆæ˜¯ç´¢å¼•ä¸‹æ ‡æ˜¯ä»¥ 1 å¼€å¤´çš„ï¼ŒKEYS[1] æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ keyï¼ŒARGV[1] æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ uuid
    -- å¦‚æœå¯¹åº”çš„ value ç­‰äºä¼ å…¥çš„ uuidã€‚
    if redis.call('get', KEYS[1]) == ARGV[1] 
        then 
        -- æ‰§è¡Œåˆ é™¤æ“ä½œ
            return redis.call('del', KEYS[1]) 
        else 
        -- åˆ é™¤ä¸æˆåŠŸï¼Œè¿”å› 0
            return 0 
    end
```



Redis è‡ªå·±å°è£…äº†ä¸€ä¸ª Redission å®¢æˆ·ç«¯ï¼Œå®ƒå†…éƒ¨ä½¿ç”¨ ReentrantLock æ¥å®ç°åˆ†å¸ƒå¼é”ï¼Œä¸è¿‡åŠ é”è§£é”ä½¿ç”¨çš„éƒ½æ˜¯ lua è„šæœ¬

ç”±äºä½¿ç”¨äº† ReentrantLock ï¼Œé‚£ä¹ˆè‡ªç„¶èƒ½å¤Ÿå®ç°é‡å…¥é”





> #### é”çš„é‡å…¥

[Redisson åˆ†å¸ƒå¼é”å®ç°åˆ†æ](https://www.jianshu.com/p/a8b3473f9c24 )



æˆ‘ä»¬å¯ä»¥æ¨æµ‹ä¸€ä¸‹ï¼ŒRedission æ˜¯åœ¨é‡å†™çš„ tryAcquire() å’Œ tryRelease() ä¸­ä½¿ç”¨ lua è„šæœ¬ æ‰§è¡ŒåŠ é”å’Œè§£é”

å…³äº Redission å¯¹é”çš„é‡å…¥ï¼Œä¸ªäººæ¨æµ‹ï¼šæ­¥éª¤å¦‚ä¸‹

- é€šè¿‡ lua è„šæœ¬æ‰§è¡Œ setnx å°è¯•è·å–é”ï¼Œ
- å¦‚æœå¤±è´¥äº†ï¼Œè¡¨ç¤ºå·²ç»æœ‰çº¿ç¨‹è·å–äº†é”ï¼Œé‚£ä¹ˆä½¿ç”¨ lua è„šæœ¬æ‰§è¡Œ get() è·å–å¯¹åº”çš„ valueï¼Œè·Ÿå½“å‰çº¿ç¨‹çš„ value(uuid) è¿›è¡Œæ¯”è¾ƒ
- å¦‚æœæ˜¯åŒä¸€ä¸ªï¼Œé‚£ä¹ˆå°†é”çš„é‡å…¥åº¦ count +1

åœ¨ä¸Šé¢ï¼Œæ‰€æœ‰çš„ redis æŒ‡ä»¤éƒ½åº”è¯¥æ˜¯åœ¨åŒä¸€ä¸ª lua è„šæœ¬çš„

```java
    return commandExecutor.evalWriteAsync(getName(), LongCodec.INSTANCE, command,
                                          //exists å‘½ä»¤ï¼Œåˆ¤æ–­ key æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨é‚£ä¹ˆè¿”å› 0ï¼Œæ‰§è¡Œä¸‹é¢ä»£ç 
                                          "if (redis.call('exists', KEYS[1]) == 0) then " +
                                          	//è®¾ç½® [key, field, value] ä¸º [key, uuid, 1]
                                          "redis.call('hset', KEYS[1], ARGV[2], 1); " +
                                          	//è®¾ç½®è¿‡æœŸæ—¶é—´
                                          "redis.call('pexpire', KEYS[1], ARGV[1]); " +
                                          	//è¿”å› null
                                          "return nil; " +
                                          	//ç»“æŸ
                                          "end; " +
                                          //å¦‚æœ exists è¿”å› 1
                                          //é‚£ä¹ˆæ‰§è¡Œ hexists å‘½ä»¤ï¼Œåˆ¤æ–­ key ä¸‹çš„ field = uuid æ˜¯å¦å­˜åœ¨
                                          "if (redis.call('hexists', KEYS[1], ARGV[2]) == 1) then " +
                                          	//å¦‚æœå­˜åœ¨ï¼Œé‚£ä¹ˆè°ƒç”¨ incr å°†å®ƒçš„é‡å…¥åº¦ +1
                                          "redis.call('hincrby', KEYS[1], ARGV[2], 1); " +
                                          	//è®¾ç½®è¿‡æœŸæ—¶é—´
                                          "redis.call('pexpire', KEYS[1], ARGV[1]); " +
                                          "return nil; " +
                                          "end; " +
                                          //å·²ç»æœ‰çº¿ç¨‹åŠ é”ï¼Œå¹¶ä¸”åŠ é”çº¿ç¨‹ä¸æ˜¯è‡ªå·±ï¼Œè°ƒç”¨ pttl è¿”å›é”çš„è¿‡æœŸæ—¶é—´
                                          "return redis.call('pttl', KEYS[1]);",
```



æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œredis åˆ†å¸ƒå¼é”éœ€è¦ç»´æŠ¤ä¸¤ä¸ª keyï¼Œ

ä¸€ä¸ªæ˜¯åˆ†å¸ƒå¼é” å’Œ æŒæœ‰è€…çš„ key - valueï¼Œä¸€ä¸ªæ˜¯åˆ†å¸ƒå¼é”å¯¹åº”çš„é‡å…¥åº¦ count ä»¥åŠå¯¹åº”å€¼çš„ key - value

ä½†å…¶å®è¿™é‡Œå¯ä»¥è¿›è¡Œç®€åŒ–ï¼Œè¿™é‡Œç›¸å½“äºå­˜åœ¨ä¸‰ä¸ªå˜é‡ï¼Œä¸€ä¸ªæ˜¯åˆ†å¸ƒå¼é”çš„ keyï¼Œä¸€ä¸ªæ˜¯æŒæœ‰é”çš„çº¿ç¨‹ uuidï¼Œä¸€ä¸ªé‡å…¥åº¦ count

è¿™æ ·çš„è¯æˆ‘ä»¬å°±å¯ä»¥ ä½¿ç”¨ä¸€ä¸ª hash æ¥å­˜å‚¨äº†ï¼Œhset key field value