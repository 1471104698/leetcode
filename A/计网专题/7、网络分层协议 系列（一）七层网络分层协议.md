# 七层网络





## 1、七层网络模型 和 TCP/IP 网络五层模型

> ### OSI 七层模型 和 网络的 五层模型

![img](https://picb.zhimg.com/80/v2-8241be381782789f7fb5735d8541c506_720w.jpg)





| OSI中的层    | 功能                                                     | TCP/IP协议族                |
| ------------ | -------------------------------------------------------- | --------------------------- |
| 7 应用层     | 指定通信的类型：邮件、CS、文件传输                       | SMTP，HTTP，FTP，DNS        |
| 6 表示层     | 数据加密解密                                             |                             |
| 5 会话层     | 信息传递给对方计算机某些程序，会话层用来区分不同的进程   |                             |
| 4 传输层     | 告知网络层需要发送什么数据                               | TCP，UDP                    |
| 3 网络层     | 到达对方主机的路径可能很多条，寻找到达对方主机的最优路径 | IP，ICMP，ARP、RARP         |
| 2 数据链路层 | 传输有地址的帧以及错误检测功能                           | MTU、VPN                    |
| 1 物理层     | 在物理媒介（电话线、空气（WIFI））上传输二进制数据       | ISO2110，IEEE802，IEEE802.2 |

 ![img](https://pic1.zhimg.com/80/12450251a3d61033e5a4bbdecebbf374_720w.jpg?source=1940ef5c) 

> ### TCP/IP 每层使用的协议

物理层：RJ45、CLOCK、IEEE802.3 **（集线器）**

数据链路： MTU 、VPN**（网卡，交换机）**

网络层：IP、ICMP（ping）、ARP、RARP **（路由器）**

传输层：TCP、UDP

会话层：

表示层：SSL

应用层：FTP、DNS、HTTP、SMTP





> ### 为什么分层

分层就跟 java 类一样，各司其职，只需要考虑自己的任务即可

并且如果有地方需要进行修改，那么修改需要变动的层即可

 **每一层独立于其他层完成自己的工作，而不需要相互依赖，上下层之间通过标准接口来互相通信，简单易用又具有扩展性。** 





## 2、IP 头部

 ![这里写图片描述](https://img-blog.csdn.net/20171118172527691?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjkzNDQ3NTc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast) 

- 版本号：比如 IPV4 和 IPV6
- 头部长度：跟 TCP 一样最小是 20 字节，但是由于 "选项" 字段存在所以需要记录头部长度
- 总长度：IP 报文的总长度， IP 头部 + TCP/UDP 头部 + 数据
- 标识：用于记录相同分片的，IP 分片后每个分片的标识一样
- 标志：3位，每一位分别为："保留/DF/MF"，DF 表示禁止分片，MF 表示当前 IP 数据报不是最后一个分片
- TTL：报文最大生存时间，经过一个路由器 TTL - 1
- 协议：TCP、UDP、ICMP
- 校验和
- 源 IP 地址
- 目的 IP 地址
- 选项

IP 头部最小为 20 字节，其他看 "选项"



> ### TTL 生存时间

为了防止数据包在网络中无限跳转，因此会设置一个 TTL

每当经过一个路由器跳转，那么 TTL -1，当为 0 时，该包丢弃



可以使用 ping + TTL  的组合来判断到达目的主机需要经过多少个路由器

比如最开始设置 TTL = 1，这时候经过一个路由转发后就变成了，被舍弃，并且由于 ping 使用的是 ICMP 报文，因此路由器会发送一个 【请求超时】 的 ICMP 差错报文

然后再设置 TTL = 2，TTL = 3，直到收到 ICMP 回应报文，这样就可以知道路径上需要经过多少个路由器了





## 3、路由器和交换机的作用

具体看 [如何跟小白解释路由器和交换机的区别？](https://www.zhihu.com/question/22007235/answer/402261894) 



在同个网段下使用的交换机，交换机连接的是同个网段内的所有主机，并且交换机会连接用于通向其他网段的 路由器

当需要跨网段传输的时候，会通过交换机获取到对应网段的路由器，然后通过路由器发送给其他网段的主机



比如下图，每个村当作一个网段，不同村的传输就是跨网段的（是否是属于同一个网段通过子网掩码来计算获取）

当在同一个村内传输的时候，只需要使用到交换机

当在不同村内传输的时候，就需要使用到路由器了

 ![img](https://pic1.zhimg.com/80/v2-6c49ad959be632e15b3f3ad70949a98e_720w.jpg?source=1940ef5c) 

**如果是在同个网段下，那么就不需要路由器，只需要交换机**

**如果是在不同网段下，那么就需要路由器**





## 4、网关

**网关实际上是一个网络段通向另外一个网络段的 入口，即一个网络段相当于是一个城池，而网关是城门。想要进入或者出去都需要经过网关**

网关是连接不同网络的设备，路由器是实现从一个网络段路由转发到另外一个网络段的设备。很显然，**路由器能够实现网关**



就如我们讲 路由器和交换机 的时候说了，在同个网段下的数据传输，不会涉及到路由器，亦即不会涉及到网关



比如主机 A 的 IP 是 192.168.0.2 / 24（这里是 24 是指子网掩码的位数，即 255.255.255.0），默认网关是 192.168.0.1

如果主机 A 发送的目的 IP 是 【192.168.0.1，192.168.0.254】，那么表示是在同个网段的，不需要网关

如果主机 A 发送的目的 IP 不是在这个范围内，那么会将数据发送到 默认网关 192.168.0.1 处，让网关去路由



默认网关：一个主机可以有多个网关，而默认网关则是如果主机找不到合适的网关了，那么将数据包发送给这个默认网关，让它自己去转发

默认路由：当路由器传输数据在自己的路由表中找不到合适的路由器时，那么就会将数据直接转发给设置的默认路由，让默认网关去传输这个数据，如果没有设置默认网关，那么数据包将直接丢弃





## 5、两个主机间的通信

主机间通信有一个问题，就是主机 A 和 主机 B 互相知道彼此的 MAC 地址，那么是否就不需要同个交换机了？？？

其实不然，主机间数据传输都需要一个媒介，不可能平白无故的我知道你的 MAC 地址就直接在空气中传输给你（当然现在好像有无限 WIFI，这种是电信号的，不过我们平时上网是插网线的），这意味着需要传播媒介，这个媒介就是交换机

使用 ARP 协议是因为 主机 A 不知道 主机 B 的 MAC 地址，所以不能直接跟 交换机 讲要传输给谁，所以需要通过 ARP 广播获取主机 B 的 MAC 地址，然后再将 IP 报文、源 MAC 地址、目的 MAC 地址 交给 交换机，交换机拿到后根据 目的 MAC 地址发送给主机 B

因此，主机间的通信都是需要通过交换机的

不过这是在通过网段内的，不同的网段通信就需要发送给默认网关，对于不同网络段的通信，IP 协议发现这是不同网络段的通信，因此 IP 层会将 IP 报文 和 默认网关的 MAC 地址、源 MAC 地址发送给 交换机，交换机根据 MAC 地址会将数据发送给 网关（路由器），然后通过 网络路由进行通信



这里需要说明一下：家用路由器不是这里的三层路由器，而是叫做路由猫，**充当着 猫、交换机、路由器 的作用**

猫：学名叫 调制解调器，它的作用是将数字信号（电脑想要发送的信息）转换成模拟信号（网线中的电流脉冲）从而使信息在网线中传输。 





## 6、路由器分组转发过程

  路由器在收到 IP 数据报 后执行的分组转发步骤如下：

1）提取 IP数据报首部 中的 目的 IP 地址

2）判断目的 IP 地址 所在的网络是否与本路由器直接相连。如果是，就直接交付给目的网络，如果不是执行3）

3）检查路由器表中是否有 目的 IP 地址 的特定主机路由。如果有，按特定主机路由转发：如果没有，执行4）

4）逐条检查路由表。若找到匹配路由，则按照路由表进行转发：若所有路由均不匹配，则执行5）

5）若路由表中设置有默认路由，则按照默认路由表转发：否则，执行6）

6）向源主机报错。



分组转发的优点感觉就是尽量匹配最优的路径进行转发，有点像策略模式

我们都希望最优的策略优先进行匹配，如果最终没有找到合适的策略，那么路由器只能将包舍弃掉

```java
if(){

}else if(){

}else if(){

}else{
    
}
```



